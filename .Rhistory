dat <- df %>% filter(!is.na(.data[[confirmed_col]]) & !is.na(.data[[deaths_col]])) %>%
arrange(desc(.data[[confirmed_col]])) %>% slice_head(n = SCATTER_N) %>%
mutate(country = .data[[country_col]],
region = ifelse(!is.na(.data[[who_col]]), as.character(.data[[who_col]]), "Unknown"))
p <- ggplot(dat, aes(x = .data[[confirmed_col]], y = .data[[deaths_col]], color = region)) +
geom_point(size = 3, alpha = 0.9) +
scale_x_continuous(labels = comma) + scale_y_continuous(labels = comma) +
labs(title = paste0("Cases vs Deaths — Top ", SCATTER_N, " Countries"), x = "Confirmed cases", y = "Deaths", color = ifelse(!is.na(who_col),"WHO Region","")) +
theme_minimal(base_size = 13) + theme(plot.title = element_text(hjust = 0.5))
lab <- dat %>% arrange(desc(.data[[confirmed_col]])) %>% slice_head(n = 8)
p + geom_text_repel(data = lab, aes(label = country), size = 3)
})()
# 4) Histogram — Distribution of confirmed cases (log-count axis)
p_hist <- (function() {
dat <- df %>% filter(!is.na(.data[[confirmed_col]]) & .data[[confirmed_col]] > 0)
ggplot(dat, aes(x = .data[[confirmed_col]])) +
geom_histogram(bins = 40, fill = "#8da0cb", color = "white") +
scale_y_log10() + scale_x_continuous(labels = comma) +
labs(title = "Distribution of Confirmed Cases (log-scaled counts)", x = "Confirmed cases", y = "Count (log scale)") +
theme_minimal(base_size = 13) + theme(plot.title = element_text(hjust = 0.5))
})()
# 5) Bar — Top recovered (optional)
p_bar_recovered <- (function() {
if (is.na(recovered_col)) return(NULL)
dat <- df %>% filter(!is.na(.data[[recovered_col]])) %>%
arrange(desc(.data[[recovered_col]])) %>% slice_head(n = TOP_N) %>%
mutate(country = .data[[country_col]])
if (nrow(dat) == 0) return(NULL)
ggplot(dat, aes(x = reorder(country, .data[[recovered_col]]), y = .data[[recovered_col]])) +
geom_col(fill = "#6baed6", color = "white") + coord_flip() +
scale_y_continuous(labels = comma) +
labs(title = paste0("Top ", TOP_N, " Countries — Recovered"), x = NULL, y = "Recovered") +
theme_minimal(base_size = 13) + theme(plot.title = element_text(hjust = 0.5))
})()
# 6) Bar — Top active (optional)
p_bar_active <- (function() {
if (is.na(active_col)) return(NULL)
dat <- df %>% filter(!is.na(.data[[active_col]])) %>%
arrange(desc(.data[[active_col]])) %>% slice_head(n = TOP_N) %>%
mutate(country = .data[[country_col]])
if (nrow(dat) == 0) return(NULL)
ggplot(dat, aes(x = reorder(country, .data[[active_col]]), y = .data[[active_col]])) +
geom_col(fill = "#f1a340", color = "white") + coord_flip() +
scale_y_continuous(labels = comma) +
labs(title = paste0("Top ", TOP_N, " Countries — Active Cases"), x = NULL, y = "Active cases") +
theme_minimal(base_size = 13) + theme(plot.title = element_text(hjust = 0.5))
})()
# 7) Line — Confirmed / Deaths / Recovered (top TOP_N countries)
p_line_metrics <- (function() {
top_countries <- df %>% filter(!is.na(.data[[confirmed_col]])) %>% arrange(desc(.data[[confirmed_col]])) %>% slice_head(n = TOP_N) %>% pull(.data[[country_col]])
dat <- df %>% filter(.data[[country_col]] %in% top_countries) %>%
select(all_of(c(country_col, confirmed_col, deaths_col, recovered_col)))
dat <- dat %>% rename(country = !!country_col, Confirmed = !!confirmed_col, Deaths = !!deaths_col)
if (!is.na(recovered_col)) dat <- dat %>% rename(Recovered = !!recovered_col)
valcols <- intersect(c("Confirmed","Deaths","Recovered"), names(dat))
long <- dat %>% pivot_longer(cols = all_of(valcols), names_to = "Metric", values_to = "Value")
order_country <- df %>% filter(!is.na(.data[[confirmed_col]])) %>% arrange(desc(.data[[confirmed_col]])) %>% slice_head(n = TOP_N) %>% pull(.data[[country_col]])
long$country <- factor(long$country, levels = order_country)
ggplot(long, aes(x = country, y = Value, color = Metric, group = Metric)) +
geom_line(aes(linetype = Metric), size = 1) + geom_point(size = 2) +
scale_y_continuous(labels = comma) +
labs(title = paste0("Confirmed / Deaths", ifelse(!is.na(recovered_col), " / Recovered", ""), " — Top ", TOP_N, " Countries"),
x = "Country (ranked by confirmed)", y = "Count") +
theme_minimal(base_size = 13) + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 35, hjust = 1))
})()
# 8) Pie — WHO region share (no slice labels; legend shows "region — %"; sorted; white borders)
p_pie <- (function() {
if (is.na(who_col)) return(NULL)
dat <- df %>% filter(!is.na(.data[[confirmed_col]])) %>%
group_by(.data[[who_col]]) %>%
summarise(total = sum(.data[[confirmed_col]], na.rm = TRUE), .groups = "drop") %>%
arrange(desc(total)) %>%
mutate(region = as.character(.data[[who_col]]))
if (nrow(dat) == 0) return(NULL)
dat <- dat %>% mutate(pct = round(100 * total / sum(total), 1),
legend_label = paste0(region, " — ", pct, "%"))
n <- nrow(dat)
pal_name <- ifelse(n <= 8, "Set2", "Paired")
pal <- RColorBrewer::brewer.pal(min(max(n,3), 12), pal_name)
ggplot(dat, aes(x = 1, y = total, fill = region)) +
geom_col(width = 1, color = "white") +
coord_polar(theta = "y") +
theme_void() +
labs(title = "Confirmed Cases — WHO Region Share") +
theme(plot.title = element_text(hjust = 0.5), legend.title = element_blank(), legend.text = element_text(size = 10)) +
scale_fill_manual(values = pal[1:n], labels = dat$legend_label)
})()
# ---------------- Render & save combined PDF ----------------
plots <- list(
p_bar_confirmed,
p_bar_deaths,
p_scatter,
p_hist,
p_bar_recovered,
p_bar_active,
p_line_metrics,
p_pie
)
# Show interactively (if in RStudio) and then write to PDF
for (p in plots) {
if (!is.null(p)) show_plot_interactive(p)
}
# Analysis.R — final (PDF-only)
# Author: Sarvadhnya Patil (2321)
# Usage: source("Analysis.R")  (RStudio interactive) or Rscript Analysis.R
#
# Output: combined PDF "plots_R.pdf" in the script folder (no images/ folder created)
# ---------------- Packages ----------------
required <- c("readr","dplyr","ggplot2","scales","stringr","ggrepel","tidyr","RColorBrewer","rstudioapi")
missing_pkgs <- required[!(required %in% rownames(installed.packages()))]
if (length(missing_pkgs)) install.packages(missing_pkgs, dependencies = TRUE)
library(readr)
library(dplyr)
library(ggplot2)
library(scales)
library(stringr)
library(ggrepel)
library(tidyr)
library(RColorBrewer)
# If running in RStudio, set working directory to the script folder for predictable output
if (interactive() && requireNamespace("rstudioapi", quietly = TRUE) && rstudioapi::hasFun("getActiveDocumentContext")) {
script_path <- rstudioapi::getActiveDocumentContext()$path
if (nzchar(script_path)) {
setwd(dirname(script_path))
message("Working directory set to script folder: ", dirname(script_path))
}
}
# ---------------- Configuration ----------------
csv_file <- "C:\\Users\\sarva\\OneDrive\\Desktop\\SEA_DST\\country-wise-covid-analysis-2321\\country_wise_latest.csv"
if (!file.exists(csv_file)) stop("CSV not found at: ", csv_file)
out_pdf  <- file.path(getwd(), "plots_R.pdf")
TOP_N    <- 10
SCATTER_N<- 50
# ---------------- Helpers ----------------
find_col <- function(df, candidates) {
nm <- names(df)
for (c in candidates) {
m <- nm[tolower(nm) == tolower(c)]
if (length(m)) return(m[1])
}
for (c in candidates) {
ix <- grep(tolower(c), tolower(nm))
if (length(ix)) return(nm[ix[1]])
}
NA_character_
}
show_plot_interactive <- function(p) {
if (interactive()) {
print(p)
readline(prompt = "Plot displayed. Press [Enter] to continue...")
} else {
# non-interactive: do nothing (pdf device will capture prints)
invisible(NULL)
}
}
# ---------------- Read & prepare data ----------------
df <- read_csv(csv_file, show_col_types = FALSE)
names(df) <- gsub("\\s+", "_", str_trim(names(df)))
country_col    <- find_col(df, c("Country/Region","Country","Country_Region"))
confirmed_col  <- find_col(df, c("Confirmed","Total_cases","TotalConfirmed","ConfirmedCases"))
deaths_col     <- find_col(df, c("Deaths","Total_deaths","TotalDeaths"))
recovered_col  <- find_col(df, c("Recovered","Total_recovered","Total_Recovered"))
active_col     <- find_col(df, c("Active","Active_cases","Active_Cases"))
population_col <- find_col(df, c("Population","Pop","population"))
who_col        <- find_col(df, c("WHO_Region","WHO Region","WHORegion"))
if (any(is.na(c(country_col, confirmed_col, deaths_col)))) {
stop("Required columns not found: Country / Confirmed / Deaths")
}
# convert numeric columns safely
numcols <- unique(na.omit(c(confirmed_col, deaths_col, recovered_col, active_col, population_col)))
for (c in numcols) df[[c]] <- as.numeric(df[[c]])
# derived metrics
df <- df %>% mutate(
CFR = ifelse(!is.na(.data[[confirmed_col]]) & .data[[confirmed_col]] > 0,
100 * .data[[deaths_col]] / .data[[confirmed_col]],
NA_real_)
)
if (!is.na(population_col)) {
df <- df %>% mutate(cases_per_million = .data[[confirmed_col]] / (.data[[population_col]] / 1e6))
}
# ---------------- Create plots (store in variables) ----------------
# 1) Bar — Top confirmed
p_bar_confirmed <- (function() {
dat <- df %>% filter(!is.na(.data[[confirmed_col]])) %>%
arrange(desc(.data[[confirmed_col]])) %>% slice_head(n = TOP_N) %>%
mutate(country = .data[[country_col]])
ggplot(dat, aes(x = reorder(country, .data[[confirmed_col]]), y = .data[[confirmed_col]])) +
geom_col(fill = "#2b8cbe", color = "white") + coord_flip() +
scale_y_continuous(labels = comma) +
labs(title = paste0("Top ", TOP_N, " Countries — Confirmed Cases"), x = NULL, y = "Confirmed cases") +
theme_minimal(base_size = 14) + theme(plot.title = element_text(hjust = 0.5))
})()
# 2) Bar — Top deaths
p_bar_deaths <- (function() {
dat <- df %>% filter(!is.na(.data[[deaths_col]])) %>%
arrange(desc(.data[[deaths_col]])) %>% slice_head(n = TOP_N) %>%
mutate(country = .data[[country_col]])
ggplot(dat, aes(x = reorder(country, .data[[deaths_col]]), y = .data[[deaths_col]])) +
geom_col(fill = "#f03b20", color = "white") + coord_flip() +
scale_y_continuous(labels = comma) +
labs(title = paste0("Top ", TOP_N, " Countries — Deaths"), x = NULL, y = "Deaths") +
theme_minimal(base_size = 14) + theme(plot.title = element_text(hjust = 0.5))
})()
# 3) Scatter — Cases vs Deaths (top SCATTER_N)
p_scatter <- (function() {
dat <- df %>% filter(!is.na(.data[[confirmed_col]]) & !is.na(.data[[deaths_col]])) %>%
arrange(desc(.data[[confirmed_col]])) %>% slice_head(n = SCATTER_N) %>%
mutate(country = .data[[country_col]],
region = ifelse(!is.na(.data[[who_col]]), as.character(.data[[who_col]]), "Unknown"))
p <- ggplot(dat, aes(x = .data[[confirmed_col]], y = .data[[deaths_col]], color = region)) +
geom_point(size = 3, alpha = 0.9) +
scale_x_continuous(labels = comma) + scale_y_continuous(labels = comma) +
labs(title = paste0("Cases vs Deaths — Top ", SCATTER_N, " Countries"), x = "Confirmed cases", y = "Deaths", color = ifelse(!is.na(who_col),"WHO Region","")) +
theme_minimal(base_size = 13) + theme(plot.title = element_text(hjust = 0.5))
lab <- dat %>% arrange(desc(.data[[confirmed_col]])) %>% slice_head(n = 8)
p + geom_text_repel(data = lab, aes(label = country), size = 3)
})()
# 4) Histogram — Distribution of confirmed cases (log-count axis)
p_hist <- (function() {
dat <- df %>% filter(!is.na(.data[[confirmed_col]]) & .data[[confirmed_col]] > 0)
ggplot(dat, aes(x = .data[[confirmed_col]])) +
geom_histogram(bins = 40, fill = "#8da0cb", color = "white") +
scale_y_log10() + scale_x_continuous(labels = comma) +
labs(title = "Distribution of Confirmed Cases (log-scaled counts)", x = "Confirmed cases", y = "Count (log scale)") +
theme_minimal(base_size = 13) + theme(plot.title = element_text(hjust = 0.5))
})()
# 5) Bar — Top recovered (optional)
p_bar_recovered <- (function() {
if (is.na(recovered_col)) return(NULL)
dat <- df %>% filter(!is.na(.data[[recovered_col]])) %>%
arrange(desc(.data[[recovered_col]])) %>% slice_head(n = TOP_N) %>%
mutate(country = .data[[country_col]])
if (nrow(dat) == 0) return(NULL)
ggplot(dat, aes(x = reorder(country, .data[[recovered_col]]), y = .data[[recovered_col]])) +
geom_col(fill = "#6baed6", color = "white") + coord_flip() +
scale_y_continuous(labels = comma) +
labs(title = paste0("Top ", TOP_N, " Countries — Recovered"), x = NULL, y = "Recovered") +
theme_minimal(base_size = 13) + theme(plot.title = element_text(hjust = 0.5))
})()
# 6) Bar — Top active (optional)
p_bar_active <- (function() {
if (is.na(active_col)) return(NULL)
dat <- df %>% filter(!is.na(.data[[active_col]])) %>%
arrange(desc(.data[[active_col]])) %>% slice_head(n = TOP_N) %>%
mutate(country = .data[[country_col]])
if (nrow(dat) == 0) return(NULL)
ggplot(dat, aes(x = reorder(country, .data[[active_col]]), y = .data[[active_col]])) +
geom_col(fill = "#f1a340", color = "white") + coord_flip() +
scale_y_continuous(labels = comma) +
labs(title = paste0("Top ", TOP_N, " Countries — Active Cases"), x = NULL, y = "Active cases") +
theme_minimal(base_size = 13) + theme(plot.title = element_text(hjust = 0.5))
})()
# 7) Line — Confirmed / Deaths / Recovered (top TOP_N countries)
p_line_metrics <- (function() {
top_countries <- df %>% filter(!is.na(.data[[confirmed_col]])) %>% arrange(desc(.data[[confirmed_col]])) %>% slice_head(n = TOP_N) %>% pull(.data[[country_col]])
dat <- df %>% filter(.data[[country_col]] %in% top_countries) %>%
select(all_of(c(country_col, confirmed_col, deaths_col, recovered_col)))
dat <- dat %>% rename(country = !!country_col, Confirmed = !!confirmed_col, Deaths = !!deaths_col)
if (!is.na(recovered_col)) dat <- dat %>% rename(Recovered = !!recovered_col)
valcols <- intersect(c("Confirmed","Deaths","Recovered"), names(dat))
long <- dat %>% pivot_longer(cols = all_of(valcols), names_to = "Metric", values_to = "Value")
order_country <- df %>% filter(!is.na(.data[[confirmed_col]])) %>% arrange(desc(.data[[confirmed_col]])) %>% slice_head(n = TOP_N) %>% pull(.data[[country_col]])
long$country <- factor(long$country, levels = order_country)
ggplot(long, aes(x = country, y = Value, color = Metric, group = Metric)) +
geom_line(aes(linetype = Metric), size = 1) + geom_point(size = 2) +
scale_y_continuous(labels = comma) +
labs(title = paste0("Confirmed / Deaths", ifelse(!is.na(recovered_col), " / Recovered", ""), " — Top ", TOP_N, " Countries"),
x = "Country (ranked by confirmed)", y = "Count") +
theme_minimal(base_size = 13) + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 35, hjust = 1))
})()
# 8) Pie — WHO region share (no slice labels; legend shows "region — %"; sorted; white borders)
p_pie <- (function() {
if (is.na(who_col)) return(NULL)
dat <- df %>% filter(!is.na(.data[[confirmed_col]])) %>%
group_by(.data[[who_col]]) %>%
summarise(total = sum(.data[[confirmed_col]], na.rm = TRUE), .groups = "drop") %>%
arrange(desc(total)) %>%
mutate(region = as.character(.data[[who_col]]))
if (nrow(dat) == 0) return(NULL)
dat <- dat %>% mutate(pct = round(100 * total / sum(total), 1),
legend_label = paste0(region, " — ", pct, "%"))
n <- nrow(dat)
pal_name <- ifelse(n <= 8, "Set2", "Paired")
pal <- RColorBrewer::brewer.pal(min(max(n,3), 12), pal_name)
ggplot(dat, aes(x = 1, y = total, fill = region)) +
geom_col(width = 1, color = "white") +
coord_polar(theta = "y") +
theme_void() +
labs(title = "Confirmed Cases — WHO Region Share") +
theme(plot.title = element_text(hjust = 0.5), legend.title = element_blank(), legend.text = element_text(size = 10)) +
scale_fill_manual(values = pal[1:n], labels = dat$legend_label)
})()
# ---------------- Render & save combined PDF ----------------
plots <- list(
p_bar_confirmed,
p_bar_deaths,
p_scatter,
p_hist,
p_bar_recovered,
p_bar_active,
p_line_metrics,
p_pie
)
# Show interactively (if in RStudio) and then write to PDF
for (p in plots) {
if (!is.null(p)) show_plot_interactive(p)
}
# Analysis.R — final (PDF-only)
# Author: Sarvadhnya Patil (2321)
# Usage: source("Analysis.R")  (RStudio interactive) or Rscript Analysis.R
#
# Output: combined PDF "plots_R.pdf" in the script folder (no images/ folder created)
# ---------------- Packages ----------------
required <- c("readr","dplyr","ggplot2","scales","stringr","ggrepel","tidyr","RColorBrewer","rstudioapi")
missing_pkgs <- required[!(required %in% rownames(installed.packages()))]
if (length(missing_pkgs)) install.packages(missing_pkgs, dependencies = TRUE)
library(readr)
library(dplyr)
library(ggplot2)
library(scales)
library(stringr)
library(ggrepel)
library(tidyr)
library(RColorBrewer)
# If running in RStudio, set working directory to the script folder for predictable output
if (interactive() && requireNamespace("rstudioapi", quietly = TRUE) && rstudioapi::hasFun("getActiveDocumentContext")) {
script_path <- rstudioapi::getActiveDocumentContext()$path
if (nzchar(script_path)) {
setwd(dirname(script_path))
message("Working directory set to script folder: ", dirname(script_path))
}
}
# ---------------- Configuration ----------------
csv_file <- "C:\\Users\\sarva\\OneDrive\\Desktop\\SEA_DST\\country-wise-covid-analysis-2321\\country_wise_latest.csv"
if (!file.exists(csv_file)) stop("CSV not found at: ", csv_file)
out_pdf  <- file.path(getwd(), "plots_R.pdf")
TOP_N    <- 10
SCATTER_N<- 50
# ---------------- Helpers ----------------
find_col <- function(df, candidates) {
nm <- names(df)
for (c in candidates) {
m <- nm[tolower(nm) == tolower(c)]
if (length(m)) return(m[1])
}
for (c in candidates) {
ix <- grep(tolower(c), tolower(nm))
if (length(ix)) return(nm[ix[1]])
}
NA_character_
}
show_plot_interactive <- function(p) {
if (interactive()) {
print(p)
readline(prompt = "Plot displayed. Press [Enter] to continue...")
} else {
# non-interactive: do nothing (pdf device will capture prints)
invisible(NULL)
}
}
# ---------------- Read & prepare data ----------------
df <- read_csv(csv_file, show_col_types = FALSE)
names(df) <- gsub("\\s+", "_", str_trim(names(df)))
country_col    <- find_col(df, c("Country/Region","Country","Country_Region"))
confirmed_col  <- find_col(df, c("Confirmed","Total_cases","TotalConfirmed","ConfirmedCases"))
deaths_col     <- find_col(df, c("Deaths","Total_deaths","TotalDeaths"))
recovered_col  <- find_col(df, c("Recovered","Total_recovered","Total_Recovered"))
active_col     <- find_col(df, c("Active","Active_cases","Active_Cases"))
population_col <- find_col(df, c("Population","Pop","population"))
who_col        <- find_col(df, c("WHO_Region","WHO Region","WHORegion"))
if (any(is.na(c(country_col, confirmed_col, deaths_col)))) {
stop("Required columns not found: Country / Confirmed / Deaths")
}
# convert numeric columns safely
numcols <- unique(na.omit(c(confirmed_col, deaths_col, recovered_col, active_col, population_col)))
for (c in numcols) df[[c]] <- as.numeric(df[[c]])
# derived metrics
df <- df %>% mutate(
CFR = ifelse(!is.na(.data[[confirmed_col]]) & .data[[confirmed_col]] > 0,
100 * .data[[deaths_col]] / .data[[confirmed_col]],
NA_real_)
)
if (!is.na(population_col)) {
df <- df %>% mutate(cases_per_million = .data[[confirmed_col]] / (.data[[population_col]] / 1e6))
}
# ---------------- Create plots (store in variables) ----------------
# 1) Bar — Top confirmed
p_bar_confirmed <- (function() {
dat <- df %>% filter(!is.na(.data[[confirmed_col]])) %>%
arrange(desc(.data[[confirmed_col]])) %>% slice_head(n = TOP_N) %>%
mutate(country = .data[[country_col]])
ggplot(dat, aes(x = reorder(country, .data[[confirmed_col]]), y = .data[[confirmed_col]])) +
geom_col(fill = "#2b8cbe", color = "white") + coord_flip() +
scale_y_continuous(labels = comma) +
labs(title = paste0("Top ", TOP_N, " Countries — Confirmed Cases"), x = NULL, y = "Confirmed cases") +
theme_minimal(base_size = 14) + theme(plot.title = element_text(hjust = 0.5))
})()
# 2) Bar — Top deaths
p_bar_deaths <- (function() {
dat <- df %>% filter(!is.na(.data[[deaths_col]])) %>%
arrange(desc(.data[[deaths_col]])) %>% slice_head(n = TOP_N) %>%
mutate(country = .data[[country_col]])
ggplot(dat, aes(x = reorder(country, .data[[deaths_col]]), y = .data[[deaths_col]])) +
geom_col(fill = "#f03b20", color = "white") + coord_flip() +
scale_y_continuous(labels = comma) +
labs(title = paste0("Top ", TOP_N, " Countries — Deaths"), x = NULL, y = "Deaths") +
theme_minimal(base_size = 14) + theme(plot.title = element_text(hjust = 0.5))
})()
# 3) Scatter — Cases vs Deaths (top SCATTER_N)
p_scatter <- (function() {
dat <- df %>% filter(!is.na(.data[[confirmed_col]]) & !is.na(.data[[deaths_col]])) %>%
arrange(desc(.data[[confirmed_col]])) %>% slice_head(n = SCATTER_N) %>%
mutate(country = .data[[country_col]],
region = ifelse(!is.na(.data[[who_col]]), as.character(.data[[who_col]]), "Unknown"))
p <- ggplot(dat, aes(x = .data[[confirmed_col]], y = .data[[deaths_col]], color = region)) +
geom_point(size = 3, alpha = 0.9) +
scale_x_continuous(labels = comma) + scale_y_continuous(labels = comma) +
labs(title = paste0("Cases vs Deaths — Top ", SCATTER_N, " Countries"), x = "Confirmed cases", y = "Deaths", color = ifelse(!is.na(who_col),"WHO Region","")) +
theme_minimal(base_size = 13) + theme(plot.title = element_text(hjust = 0.5))
lab <- dat %>% arrange(desc(.data[[confirmed_col]])) %>% slice_head(n = 8)
p + geom_text_repel(data = lab, aes(label = country), size = 3)
})()
# 4) Histogram — Distribution of confirmed cases (log-count axis)
p_hist <- (function() {
dat <- df %>% filter(!is.na(.data[[confirmed_col]]) & .data[[confirmed_col]] > 0)
ggplot(dat, aes(x = .data[[confirmed_col]])) +
geom_histogram(bins = 40, fill = "#8da0cb", color = "white") +
scale_y_log10() + scale_x_continuous(labels = comma) +
labs(title = "Distribution of Confirmed Cases (log-scaled counts)", x = "Confirmed cases", y = "Count (log scale)") +
theme_minimal(base_size = 13) + theme(plot.title = element_text(hjust = 0.5))
})()
# 5) Bar — Top recovered (optional)
p_bar_recovered <- (function() {
if (is.na(recovered_col)) return(NULL)
dat <- df %>% filter(!is.na(.data[[recovered_col]])) %>%
arrange(desc(.data[[recovered_col]])) %>% slice_head(n = TOP_N) %>%
mutate(country = .data[[country_col]])
if (nrow(dat) == 0) return(NULL)
ggplot(dat, aes(x = reorder(country, .data[[recovered_col]]), y = .data[[recovered_col]])) +
geom_col(fill = "#6baed6", color = "white") + coord_flip() +
scale_y_continuous(labels = comma) +
labs(title = paste0("Top ", TOP_N, " Countries — Recovered"), x = NULL, y = "Recovered") +
theme_minimal(base_size = 13) + theme(plot.title = element_text(hjust = 0.5))
})()
# 6) Bar — Top active (optional)
p_bar_active <- (function() {
if (is.na(active_col)) return(NULL)
dat <- df %>% filter(!is.na(.data[[active_col]])) %>%
arrange(desc(.data[[active_col]])) %>% slice_head(n = TOP_N) %>%
mutate(country = .data[[country_col]])
if (nrow(dat) == 0) return(NULL)
ggplot(dat, aes(x = reorder(country, .data[[active_col]]), y = .data[[active_col]])) +
geom_col(fill = "#f1a340", color = "white") + coord_flip() +
scale_y_continuous(labels = comma) +
labs(title = paste0("Top ", TOP_N, " Countries — Active Cases"), x = NULL, y = "Active cases") +
theme_minimal(base_size = 13) + theme(plot.title = element_text(hjust = 0.5))
})()
# 7) Line — Confirmed / Deaths / Recovered (top TOP_N countries)
p_line_metrics <- (function() {
top_countries <- df %>% filter(!is.na(.data[[confirmed_col]])) %>% arrange(desc(.data[[confirmed_col]])) %>% slice_head(n = TOP_N) %>% pull(.data[[country_col]])
dat <- df %>% filter(.data[[country_col]] %in% top_countries) %>%
select(all_of(c(country_col, confirmed_col, deaths_col, recovered_col)))
dat <- dat %>% rename(country = !!country_col, Confirmed = !!confirmed_col, Deaths = !!deaths_col)
if (!is.na(recovered_col)) dat <- dat %>% rename(Recovered = !!recovered_col)
valcols <- intersect(c("Confirmed","Deaths","Recovered"), names(dat))
long <- dat %>% pivot_longer(cols = all_of(valcols), names_to = "Metric", values_to = "Value")
order_country <- df %>% filter(!is.na(.data[[confirmed_col]])) %>% arrange(desc(.data[[confirmed_col]])) %>% slice_head(n = TOP_N) %>% pull(.data[[country_col]])
long$country <- factor(long$country, levels = order_country)
ggplot(long, aes(x = country, y = Value, color = Metric, group = Metric)) +
geom_line(aes(linetype = Metric), size = 1) + geom_point(size = 2) +
scale_y_continuous(labels = comma) +
labs(title = paste0("Confirmed / Deaths", ifelse(!is.na(recovered_col), " / Recovered", ""), " — Top ", TOP_N, " Countries"),
x = "Country (ranked by confirmed)", y = "Count") +
theme_minimal(base_size = 13) + theme(plot.title = element_text(hjust = 0.5), axis.text.x = element_text(angle = 35, hjust = 1))
})()
# 8) Pie — WHO region share (no slice labels; legend shows "region — %"; sorted; white borders)
p_pie <- (function() {
if (is.na(who_col)) return(NULL)
dat <- df %>% filter(!is.na(.data[[confirmed_col]])) %>%
group_by(.data[[who_col]]) %>%
summarise(total = sum(.data[[confirmed_col]], na.rm = TRUE), .groups = "drop") %>%
arrange(desc(total)) %>%
mutate(region = as.character(.data[[who_col]]))
if (nrow(dat) == 0) return(NULL)
dat <- dat %>% mutate(pct = round(100 * total / sum(total), 1),
legend_label = paste0(region, " — ", pct, "%"))
n <- nrow(dat)
pal_name <- ifelse(n <= 8, "Set2", "Paired")
pal <- RColorBrewer::brewer.pal(min(max(n,3), 12), pal_name)
ggplot(dat, aes(x = 1, y = total, fill = region)) +
geom_col(width = 1, color = "white") +
coord_polar(theta = "y") +
theme_void() +
labs(title = "Confirmed Cases — WHO Region Share") +
theme(plot.title = element_text(hjust = 0.5), legend.title = element_blank(), legend.text = element_text(size = 10)) +
scale_fill_manual(values = pal[1:n], labels = dat$legend_label)
})()
# ---------------- Render & save combined PDF ----------------
plots <- list(
p_bar_confirmed,
p_bar_deaths,
p_scatter,
p_hist,
p_bar_recovered,
p_bar_active,
p_line_metrics,
p_pie
)
# Show interactively (if in RStudio) and then write to PDF
for (p in plots) {
if (!is.null(p)) show_plot_interactive(p)
}
